const remSize=parseInt(getComputedStyle(document.documentElement).fontSize),size=8,problemNum=8,meiro=new Array(12);let score=0,counter=0,processed,idioms=[];const words="アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲンヴガギグゲゴザジズゼゾダヂヅデドバビブベボパピプペポァィゥェォッャュー".split("");loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function shuffle(e){for(let t=e.length;1<t;t--){const n=Math.floor(Math.random()*t);[e[n],e[t-1]]=[e[t-1],e[n]]}return e}function calcReply(){const e=new Array(size*size),t=document.getElementById("meiro").children;for(let n=0;n<size;n++){const s=t[n].children;for(let t=0;t<size;t++){const i=s[t].classList.contains("table-primary"),a=s[t].classList.contains("table-secondary"),o=meiro[n][t];o>0&&(i||a)&&(e[o-1]=s[t].textContent)}}return e}function findMeiroIndex(e){for(let t=0;t<size;t++)for(let n=0;n<size;n++)if(meiro[t][n]==e)return t*size+n;return-1}function prependIdiomLink(e,t){const n=document.createElement("a");n.textContent=e,n.href="https://www.google.com/search?q="+e+"とは",n.target="_blank",n.rel="noopener noreferer",t?n.className="btn btn-light m-1":n.className="btn btn-secondary m-1",n.role="button",solvedPanel.prepend(n)}function showSolved(e,t){const s=document.getElementById("meiro").children;let o=0,n=0;for(let i=0;i<counter;i++){const a=idioms[o];if(!processed[i])if(e[i]==a[n]){if(n==a.length-1){const e=i-n+1;if(processed[e]){const t=findMeiroIndex(e),n=s[Math.floor(t/size)].children[t%size];n.classList.contains("table-secondary")?score+=1:score+=a.length,prependIdiomLink(a,!0)}document.getElementById("score").textContent=score}processed[i]=!0}else if(t){const o=i-n+1,e=findMeiroIndex(o),t=s[Math.floor(e/size)].children[e%size];t.className="",t.classList.add("table-secondary")}else{prependIdiomLink(a,!1);const e=i-n;for(let t=e;t<e+a.length;t++){processed[t]=!0;const n=findMeiroIndex(t+1),o=s[Math.floor(n/size)].children[n%size];o.className="",o.classList.add("table-secondary")}}n==a.length-1?(o+=1,n=0):n+=1}}function showHint(){const e=calcReply();showSolved(e,!0)}function showAnswer(){const t=calcReply();showSolved(t,!1);const n=document.getElementById("meiro").children;for(let e=0;e<size;e++){const t=n[e].children;for(let n=0;n<size;n++)meiro[e][n]>0&&(t[n].className="",t[n].classList.add("table-danger"))}const e=document.getElementById("startButton");e.classList.remove("d-none"),e.textContent="スタート";const s=document.getElementById("answerButton");s.classList.add("d-none")}function getNeighborText(e,t,n,s){let o=e[t].children[n].textContent;return s==1?meiro[t-1][n]!=0&&(o+=e[t-1].children[n].textContent):s==2?meiro[t+1][n]!=0&&(o+=e[t+1].children[n].textContent):s==3?meiro[t][n-1]!=0&&(o+=e[t].children[n-1].textContent):meiro[t][n+1]!=0&&(o+=e[t].children[n+1].textContent),o}function setNeighborText(e,t,n,s,o,i){i||(e[t].children[n].textContent=o[0]),s==1?e[t-1].children[n].textContent=o[1]:s==2?e[t+1].children[n].textContent=o[1]:s==3?e[t].children[n-1].textContent=o[1]:e[t].children[n+1].textContent=o[1]}function generateRandomText(e,t){if(t){{const t=e[0];for(let n=0;n<5;n++)if(e=t+words[getRandomInt(0,words.length)],!includeIdiom(e))return e}}else for(let t=0;t<5;t++){for(let t=0;t<2;t++)e[t]=words[getRandomInt(0,words.length)];if(!includeIdiom(e))return e}return e}function includeIdiom(e){return!!idioms.includes(e.slice(0,2))}function strictNeighbor(e,t,n,s,o){let i=getNeighborText(e,t,n,s);i.length==2&&(i=generateRandomText(i,o),setNeighborText(e,t,n,s,i,o))}function strictSolution(){const e=document.getElementById("meiro").children;for(let t=0;t<size;t++)for(let n=0;n<size;n++)if(meiro[t][n]==0)0<=t-1&&strictNeighbor(e,t,n,1,!1),t+1<size&&strictNeighbor(e,t,n,2,!1),0<=n-1&&strictNeighbor(e,t,n,3,!1),n+1<size&&strictNeighbor(e,t,n,4,!1);else{const s=getNeighborRoutes(t,n);for(let o=0;o<s.length;o++)strictNeighbor(e,t,n,s[o][2],!0)}}function startGame(){for(;solvedPanel.firstChild;)solvedPanel.removeChild(solvedPanel.firstChild);generateGame(),strictSolution();const e=document.getElementById("startButton");e.classList.add("d-none"),e.textContent="やり直し";const t=document.getElementById("answerButton");t.classList.remove("d-none")}function getNeighborRoutes(e,t){const n=[];return 0<=e-1&&meiro[e-1][t]==0&&n.push([e-1,t,1]),e+1<size&&meiro[e+1][t]==0&&n.push([e+1,t,2]),0<=t-1&&meiro[e][t-1]==0&&n.push([e,t-1,3]),t+1<size&&meiro[e][t+1]==0&&n.push([e,t+1,4]),n}function paint(e,t,n,s){if(n==1){for(let n=0;n<s;n++)counter+=1,meiro[e-n][t]=counter;return[e-s+1,t]}if(n==2){for(let n=0;n<s;n++)counter+=1,meiro[e+n][t]=counter;return[e+s-1,t]}if(n==3){for(let n=0;n<s;n++)counter+=1,meiro[e][t-n]=counter;return[e,t-s+1]}for(let n=0;n<s;n++)counter+=1,meiro[e][t+n]=counter;return[e,t+s-1]}function _p(){let e="";for(let t=0;t<size;t++){for(let n=0;n<size;n++)e+=meiro[t][n];e+=`
`}console.log(e)}function isPassable(e,t,n,s){let o=!0;if(n==1){{if(e-s<0)return!1;for(let n=0;n<s;n++)if(meiro[e-n][t]!=0){o=!1;break}}}else if(n==2){{if(size<=e+s)return!1;for(let n=0;n<s;n++)if(meiro[e+n][t]!=0){o=!1;break}}}else if(n==3){{if(t-s<0)return!1;for(let n=0;n<s;n++)if(meiro[e][t-n]!=0){o=!1;break}}}else{if(size<=t+s)return!1;for(let n=0;n<s;n++)if(meiro[e][t+n]!=0){o=!1;break}}return o}function generateGame(){idioms=shuffle(idioms);let s=!0;for(;s;){counter=0;for(let e=0;e<size;e++){meiro[e]=new Array(size);for(let t=0;t<size;t++)meiro[e][t]=0}let e=0,t=0;for(e=0;e<problemNum;e++){let n=!1;for(let a=0;a<5;a++){const o=getRandomInt(0,size),i=getRandomInt(0,size),s=getRandomInt(1,5);if(isPassable(o,i,s,idioms[e].length)){s==1?(paint(o-idioms[e].length+1,i,2,idioms[e].length),t+=0):s==3?(paint(o,i-idioms[e].length+1,4,idioms[e].length),t+=1):(paint(o,i,s,idioms[e].length),t+=Math.floor(s/4)),n=!0;break}}if(!n)break}e==problemNum&&t!=0&&t!=problemNum&&(s=!1)}processed=new Array(counter);const e=document.getElementById("meiro");for(;e.firstChild;)e.removeChild(e.firstChild);for(let t=0;t<size;t++){const n=document.createElement("tr");e.appendChild(n);for(let t=0;t<size;t++){const e=document.createElement("td");e.textContent=words[getRandomInt(0,words.length)],n.appendChild(e),e.onclick=()=>{e.classList.toggle("table-primary")}}}const o=e.children;let n=0,t=0;for(let e=1;e<=counter;e++){const s=findMeiroIndex(e),i=idioms[n][t],a=o[Math.floor(s/size)].children[s%size];a.textContent=i,t==idioms[n].length-1?(n+=1,t=0):t+=1}}function resizeFontSize(e){const t=document.getElementById("masu").offsetWidth,n=1.2,s=remSize*8,o=9,i=(t-s-o)/8/n;e.style.fontSize=i+"px"}const meiroObj=document.getElementById("meiro");resizeFontSize(meiroObj),window.addEventListener("resize",()=>{resizeFontSize(meiroObj)}),fetch("words.lst").then(e=>e.text()).then(e=>{for(e.trim().split(`
`).forEach(e=>{idioms.push(e)}),generateGame(),strictSolution();solvedPanel.firstChild;)solvedPanel.removeChild(solvedPanel.firstChild);showAnswer()}),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=startGame,document.getElementById("answerButton").onclick=showAnswer,document.getElementById("hintButton").onclick=showHint